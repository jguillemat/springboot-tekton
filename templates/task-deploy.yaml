apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  labels:
{{ include "springboot-tekton.labels" . | nindent 4 }}
  name: deploy
spec:
  params:
    - name: fromNamespace
      description: The namespace we are tagging from
    - name: toNamespace
      description: The namespace we are tagging to
    - name: tag
      description: The image tag
    - name: imageStream
      description: The imageStream
    - name: deployment
      description: the deployment
  resources:
    inputs:
    - name: templates
      type: git
  steps:

    - name: update-deployment-from-template
      image: quay.io/openshift-pipeline/openshift-cli:latest
      workingDir: /workspace/templates/basic-spring-boot-tekton
      script: |
        #!/usr/bin/env bash
        echo "Updating namespace $(params.toNamespace)"
        oc process \
          -f .openshift/templates/deployment.yml \
          -p "APPLICATION_NAME=$(params.imageStream)" \
          -p "NAMESPACE=$(params.toNamespace)" \
          -p READINESS_PATH="/health" \
          -p READINESS_RESPONSE="status.:.UP" \
          | oc apply -f -
      resources:
        limits:
          cpu: 0.25
          memory: 200Mi

    - name: tag-image
      image: quay.io/openshift-pipeline/openshift-cli:latest
      command: ["/usr/local/bin/oc"]
      args:
        - tag
        - "$(params.fromNamespace)/$(params.imageStream):$(params.tag)"
        - "$(params.toNamespace)/$(params.imageStream):$(params.tag)"
      resources:
        limits:
          cpu: 0.25
          memory: 200Mi

    - name: verify-deployment
      image: quay.io/openshift-pipeline/openshift-cli:latest
      command: ["/usr/local/bin/oc"]
      args:
        - rollout
        - status
        - "dc/$(params.deployment)"
        - -n
        - "$(params.toNamespace)"
      resources:
        limits:
          cpu: 0.25
          memory: 200Mi